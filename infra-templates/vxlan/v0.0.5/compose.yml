version: "2"
services:
  cni-driver:
    command: sh -c "touch /var/log/rancher-cni.log && exec tail ---disable-inotify
      -F /var/log/rancher-cni.log"
    image: rancher/net:v0.9.4
    labels:
      io.rancher.container.dns: "true"
      io.rancher.network.cni.binary: rancher-bridge
    logging:
      driver: json-file
      options:
        max-file: "2"
        max-size: 25m
    network_mode: host
    pid: host
    privileged: true
  vxlan:
    cap_add:
    - NET_ADMIN
    command: start-vxlan.sh
    environment:
      RANCHER_DEBUG: ${RANCHER_DEBUG}
    image: rancher/net:v0.9.4
    labels:
      io.rancher.cni.link_mtu_overhead: "0"
      io.rancher.container.agent_service.vxlan: "true"
      io.rancher.container.create_agent: "true"
      io.rancher.internal.service.vxlan: "true"
      io.rancher.scheduler.global: "true"
      io.rancher.service.selector.link: io.rancher.internal.service.vxlan=true
      io.rancher.sidekicks: cni-driver
    logging:
      driver: json-file
      options:
        max-file: "2"
        max-size: 25m
    network_driver:
      cni_config:
        10-rancher-vxlan.conf:
          bridge: $DOCKER_BRIDGE
          bridgeSubnet: $SUBNET
          hairpinMode: true
          hostNat: true
          ipam:
            isDebugLevel: ${RANCHER_DEBUG}
            logToFile: /var/log/rancher-cni.log
            routes:
            - dst: 169.254.169.250/32
            type: rancher-cni-ipam
          isDebugLevel: ${RANCHER_DEBUG}
          isDefaultGateway: true
          linkMTUOverhead: 50
          logToFile: /var/log/rancher-cni.log
          mtu: ${MTU}
          name: rancher-cni-network
          type: rancher-bridge
      default_network:
        dns:
        - 169.254.169.250
        dns_search:
        - rancher.internal
        host_ports: true
        name: vxlan
        subnets:
        - network_address: $SUBNET
      name: Rancher VXLAN
    network_mode: vxlan
    ports:
    - 4789:4789/udp
    volumes_from:
    - cni-driver
